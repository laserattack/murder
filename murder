#!/usr/bin/env perl

use strict;
use warnings;
use feature 'say';
use Time::HiRes 'sleep';

our @SIGNALS = (
    [15, 3],
    [2, 3],
    [1, 4],
    [9, 0]
);

sub go_ahead {
    my $input = <STDIN>;
    chomp($input);
    $input =~ s/^\s+|\s+$//g;
    $input = lc($input);
     
    return 1 if $input eq '';
    return $input =~ /^(y|yes|yas)$/ ? 1 : 0;
}

sub is_running {
    my ($pid) = @_;
    return `ps -p $pid` =~ tr/\n// == 2;
}

sub get_all_descendants {
    my ($pid) = @_;
    my %result;
    
    my $find_children;
    $find_children = sub {
        my ($parent) = @_;
        my @children = split(/\n/, `ps -eo pid,ppid | awk '\$2 == $parent {print \$1}'`);
        foreach my $child (@children) {
            next if $result{$child}++;
            $find_children->($child);
        }
    };
    
    $find_children->($pid);
    return keys %result;
}

sub murder_pid {
    my ($pid) = @_;
    
    my @all_pids = get_all_descendants($pid);
    unshift @all_pids, $pid;
    
    say "Process tree: " . join(', ', @all_pids);
    
    foreach my $target_pid (reverse @all_pids) {
        next unless is_running($target_pid);
        
        foreach my $sig (@SIGNALS) {
            my ($code, $wait) = @$sig;
            say "Sending signal $code to pid $target_pid";
            kill($code, $target_pid);
            sleep(0.3);
            last unless is_running($target_pid);
            sleep($wait);
        }
    }
}

sub murder_port {
    my ($port) = @_;
    $port =~ s/^://;
    my @pids = split(/\n/, `lsof -ti:$port`);
    foreach my $pid (@pids) {
        my $command = `ps -p $pid -o comm=`;
        chomp($command);
        print("Kill process '$command' (pid $pid)? [Y/n] ");
        if (go_ahead()) {
            murder_pid($pid);
        }
    }
}

sub murder_names {
    my ($name) = @_;
    my $running = `ps -eo 'pid command' | grep -Fiw '$name' | grep -Fv grep`;
    foreach my $line (split(/\n/, $running)) {
        my ($pid, $command) = $line =~ /^\s*(\d+)\s+(.+?)\s*$/;
        next if $$ == $pid;
        print("Kill process '$command' (pid $pid)? [Y/n] ");
        if (go_ahead()) {
            murder_pid($pid);
        }
    }
}

sub murder {
    my ($arg) = @_;
    if ($arg =~ /^\d+$/) {
        murder_pid($arg);
    } elsif ($arg =~ /^:\d+$/) {
        murder_port($arg);
    } else {
        murder_names($arg);
    }
}

if (@ARGV < 1) {
    say 'murder 123    # kill by pid';
    say 'murder ruby   # kill by process name'; 
    say 'murder :3000  # kill by port';
} else {
    foreach my $arg (@ARGV) {
        murder($arg);
    }
}
